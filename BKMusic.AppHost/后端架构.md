这是一个基于 **.NET Aspire** 编排的云原生微服务架构方案。企业级后端的核心在于：**职责分离**、**数据一致性**、**高性能流媒体处理**以及**全链路可观测性**。

以下是详细的后端架构设计：

---

### 1. 总体架构拓扑 (Architecture Topology)

系统被划分为 **接入层**、**业务服务层**、**基础设施层**，全部由 **.NET Aspire** (`AppHost`) 统一管理启动和连接字符串注入。

#### 逻辑视图
```text
[Client] -> [CDN] (Audio/Images)
   |
   v
[YARP Gateway] (Auth Offloading, Rate Limiting)
   |
   +--> [Identity Service] (Auth, User Mgmt)
   +--> [Catalog Service] (Read-Heavy, Caching)
   +--> [Media Service] (Write-Heavy, Uploads)
   +--> [User Library Service] (User Interactions)
   +--> [Search Service] (Full-text Search)
   
[Background Workers]
   +--> [Transcode Worker] (FFmpeg Processing)
   +--> [Search Indexer] (Sync DB to Elastic/Meilisearch)
```

---

### 2. .NET Aspire 编排设计 (`AppHost`)

`MusicApp.AppHost` 是整个系统的“指挥官”。

```csharp
var builder = DistributedApplication.CreateBuilder(args);

// 1. 基础设施 (Infrastructure)
var redis = builder.AddRedis("redis");
var postgres = builder.AddPostgres("postgres")
                     .WithPgAdmin(); // 开发时方便查看数据
var rabbitmq = builder.AddRabbitMQ("rabbitmq");
var minio = builder.AddMinIO("minio"); // 本地模拟 S3

// 2. 核心数据库 (Databases)
var catalogDb = postgres.AddDatabase("catalog-db");
var identityDb = postgres.AddDatabase("identity-db");
var mediaDb = postgres.AddDatabase("media-db");

// 3. 微服务 (Microservices)
var identitySvc = builder.AddProject<Projects.IdentityService>("identity-svc")
                         .WithReference(identityDb);

var catalogSvc = builder.AddProject<Projects.CatalogService>("catalog-svc")
                        .WithReference(catalogDb)
                        .WithReference(redis) //用于缓存
                        .WithReference(rabbitmq); //用于发送变更消息

var mediaSvc = builder.AddProject<Projects.MediaService>("media-svc")
                      .WithReference(mediaDb)
                      .WithReference(minio)
                      .WithReference(rabbitmq);

// 4. 后台 Worker (不直接暴露 HTTP 端口)
builder.AddProject<Projects.TranscodingWorker>("transcode-worker")
       .WithReference(minio)
       .WithReference(rabbitmq);

// 5. API 网关 (Gateway)
builder.AddProject<Projects.ApiGateway>("gateway")
       .WithReference(identitySvc)
       .WithReference(catalogSvc)
       .WithReference(mediaSvc);

builder.Build().Run();
```

---

### 3. 各服务详细设计

每个服务都采用 **Clean Architecture** (Api -> Application -> Domain -> Infrastructure)。

#### A. API Gateway (YARP)
*   **技术栈:** YARP (Yet Another Reverse Proxy).
*   **职责:**
    *   **路由转发:** 将 `/api/catalog/*` 转发给 `catalog-svc`。
    *   **统一鉴权:** 在网关层校验 JWT Token 的有效性（仅校验签名和过期），解析 `UserId` 和 `Role` 放入 Header 传给下游服务。
    *   **限流 (Rate Limiting):** 防止恶意刷接口。
    *   **聚合:** 如果前端需要一次获取“用户信息+推荐歌单”，网关可以做简单的聚合（或者引入 BFF 层）。

#### B. Catalog Service (目录服务)
*   **性质:** **读多写少**。
*   **核心功能:** 维护 Artist, Album, Song 的元数据。
*   **性能优化策略:**
    *   **多级缓存:** 使用 Redis 缓存热门歌单、歌曲详情。使用 Decorator 模式装饰 Repository 实现缓存逻辑。
    *   **读写分离:** 如果通过 Postgres 实现，配置 Read Replica。
*   **数据同步:** 当管理员修改歌曲信息时，发布 `SongUpdatedEvent` 到 RabbitMQ，通知 Search Service 更新索引。

#### C. Media Service (媒体服务 - 核心难点)
*   **性质:** **IO 密集型 + CPU 密集型 (转码)**。
*   **流程设计:**
    1.  **预签名上传:** 前端请求上传 -> API 返回 MinIO/S3 的 Presigned URL (PUT) -> 前端直传对象存储（不经过后端服务器带宽）。
    2.  **确认上传:** 前端上传完成后调用 API `ConfirmUpload`。
    3.  **异步转码:** API 发送 `MediaUploadedEvent` 到 RabbitMQ，然后立即返回“处理中”状态给前端。

#### D. Transcoding Worker (后台转码服务)
*   **性质:** 纯后台 Worker Service，监听 RabbitMQ。
*   **技术栈:** `FFmpeg.AutoGen` 或 命令行调用 FFmpeg。
*   **工作流:**
    1.  消费 `MediaUploadedEvent`。
    2.  从 MinIO 下载原始无损音频 (FLAC/WAV)。
    3.  **HLS 切片:** 将音频转换为 `.m3u8` 索引文件和多个 `.ts` 切片文件 (支持自适应码率: 128k, 320k)。
    4.  提取音频波形数据 (Json 格式)，用于前端绘制波形图。
    5.  上传处理后的文件回 MinIO。
    6.  发布 `MediaProcessedEvent` (通知 Catalog 服务更新歌曲状态为“可播放”)。

#### E. Search Service (搜索服务)
*   **技术栈:** Elasticsearch 或 Meilisearch (推荐 Meilisearch，轻量且对 Typos 容错好)。
*   **实现:**
    *   不直接写库。
    *   监听 `Catalog` 服务的 `SongCreated`, `SongUpdated` 消息，实现数据**最终一致性**。

---

### 4. 关键技术实现细节

#### 4.1 通讯协议规范
*   **外部 (Frontend -> Gateway):** RESTful API (JSON).
*   **内部 (Service -> Service):**
    *   **gRPC:** 用于强一致性的即时调用 (例如：MediaService 调用 IdentityService 校验用户空间配额)。
    *   **MassTransit (RabbitMQ):** 用于解耦 (例如：上传 -> 转码 -> 索引)。

#### 4.2 数据库设计 (Code First)

**Catalog Context (PostgreSQL):**
```csharp
public class Song {
    public Guid Id { get; set; }
    public string Title { get; set; }
    public Guid ArtistId { get; set; }
    // 不存具体的 URL，因为 URL 是生成的（带签名）
    public string StorageKey { get; set; } 
    public SongStatus Status { get; set; } // Uploading, Processing, Ready
}
```

#### 4.3 播放鉴权与防盗链 (Security)
为了防止用户拿到 MP3 URL 后随意分享，必须使用 **Signed URLs (预签名 URL)**。

1.  Flutter 请求 `GET /api/songs/{id}/play`。
2.  后端验证用户 VIP 身份。
3.  后端使用 AWS SDK (MinIO) 生成一个带签名的 URL，设置过期时间（如 1 小时）。
    ```csharp
    var url = _minioClient.PresignedGetObjectAsync(new PresignedGetObjectArgs()
        .WithBucket("music")
        .WithObject("hls/song_123/index.m3u8")
        .WithExpiry(3600));
    ```
4.  返回 URL 给前端 `just_audio` 播放。

#### 4.4 可观测性 (Observability)
Aspire 默认集成了 **OpenTelemetry**。

*   **Logs:** 结构化日志，记录 `CorrelationId`。
*   **Traces:** 可以看到一个请求从 Gateway -> Catalog -> Redis -> DB 的完整瀑布图。
*   **Metrics:** 监控 CPU、内存、请求 RPS、RabbitMQ 队列积压数（积压太多说明需要扩容 Worker）。

---

### 5. 推荐 NuGet 库清单

| 类别 | 库名称 | 用途 |
| :--- | :--- | :--- |
| **核心** | `Microsoft.Extensions.Hosting` | 通用主机构建 |
| **API** | `Carter` 或 `FastEndpoints` | 轻量级 Minimal API 封装 (比 Controller 更现代化) |
| **数据库** | `Microsoft.EntityFrameworkCore.Npgsql` | PG 驱动 |
| **对象映射** | `Mapster` | 高性能 DTO 映射 (比 AutoMapper 快) |
| **消息队列** | `MassTransit` | 最强 .NET 消息总线库 (支持 RabbitMQ/AzureSB) |
| **网关** | `YARP.ReverseProxy` | 微软官方反向代理 |
| **验证** | `FluentValidation` | 强类型参数校验 |
| **存储** | `AWSSDK.S3` | 操作 MinIO 或 AWS S3 |
| **搜索** | `Meilisearch` | 搜索客户端 |
| **Resilience** | `Microsoft.Extensions.Http.Resilience` | 基于 Polly 的重试、熔断机制 |

---

### 6. 企业级部署思路 (DevOps)

虽然开发时用 Aspire 编排容器，但生产环境通常部署到 K8s。

1.  **Aspirate:** 使用 `Aspirate` 工具将 Aspire 项目导出为 Kubernetes Manifests (YAML) 或 Helm Chart。
2.  **CI/CD:**
    *   Github Actions 运行 `dotnet test`。
    *   构建 Docker 镜像推送到 Registry。
    *   更新 GitOps 仓库 (ArgoCD) 自动同步到生产集群。

### 总结

这个架构的关键在于：
1.  **Media Service 和 Worker 分离**：保证转码不卡死 Web 服务。
2.  **Aspire 统一管理**：解决了微服务“启动难、配置难、监控难”的问题。
3.  **HLS + 预签名**：这是音乐播放器区别于普通 CRUD 系统的核心业务壁垒。